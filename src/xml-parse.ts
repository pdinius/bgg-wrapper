const xml = `<?xml version="1.0" encoding="UTF-8"?>
<items termsofuse="https://boardgamegeek.com/xmlapi/termsofuse"><item type="boardgame" id="233078">
<thumbnail>https://cf.geekdo-images.com/_Ppn5lssO5OaildSE-FgFA__thumb/img/lfEukJE0JsoZZObaF9K9YnFp62E=/fit-in/200x150/filters:strip_icc()/pic3727516.jpg</thumbnail>
<image>https://cf.geekdo-images.com/_Ppn5lssO5OaildSE-FgFA__original/img/kVpZ0Maa_LeQGWxOqsYKP3N4KUY=/0x0/filters:format(jpeg)/pic3727516.jpg</image>
<name type="primary" sortindex="1" value="Twilight Imperium: Fourth Edition"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Cuarta Edición"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Quarta Edição"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Quarta Edizione"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Quatrième Édition"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Świt Nowej Ery"/>
<name type="alternate" sortindex="1" value="Twilight Imperium: Vierte Edition"/>
<name type="alternate" sortindex="1" value="Сумерки империи: Четвёртое издание"/>
<name type="alternate" sortindex="1" value="トワイライト・インぺリウム第4版"/>
<name type="alternate" sortindex="1" value="帝国曙光 第4版"/>
<name type="alternate" sortindex="1" value="여명의 제국"/>
<description>Twilight Imperium (Fourth Edition) is a game of galactic conquest in which three to six players take on the role of one of seventeen factions vying for galactic domination through military might, political maneuvering, and economic bargaining. Every faction offers a completely different play experience, from the wormhole-hopping Ghosts of Creuss to the Emirates of Hacan, masters of trade and economics. These seventeen races are offered many paths to victory, but only one may sit upon the throne of Mecatol Rex as the new masters of the galaxy.&amp;#10;&amp;#10;No two games of Twilight Imperium are ever identical. At the start of each galactic age, the game board is uniquely and strategically constructed using 51 galaxy tiles that feature everything from lush new planets and supernovas to asteroid fields and gravity rifts. Players are dealt a hand of these tiles and take turns creating the galaxy around Mecatol Rex, the capital planet seated in the center of the board. An ion storm may block your race from progressing through the galaxy while a fortuitously placed gravity rift may protect you from your closest foes. The galaxy is yours to both craft and dominate.&amp;#10;&amp;#10;A round of Twilight Imperium begins with players selecting one of eight strategy cards that both determine player order and give their owner a unique strategic action for that round. These may do anything from providing additional command tokens to allowing a player to control trade throughout the galaxy. After these roles are selected, players take turns moving their fleets from system to system, claiming new planets for their empire, and engaging in warfare and trade with other factions. At the end of a turn, players gather in a grand council to pass new laws and agendas, shaking up the game in unpredictable ways.&amp;#10;&amp;#10;After every player has passed their turn, players move up the victory track by checking to see whether they have completed any objectives throughout the turn and scoring them. Objectives are determined by setting up ten public objective cards at the start of each game, then gradually revealing them with every round. Every player also chooses between two random secret objectives at the start of the game, providing victory points achievable only by the holder of that objective. These objectives can be anything from researching new technologies to taking your neighbor's home system. At the end of every turn, a player can claim one public objective and one secret objective. As play continues, more of these objectives are revealed and more secret objectives are dealt out, giving players dynamically changing goals throughout the game. Play continues until a player reaches ten victory points.&amp;#10;&amp;#10;&amp;mdash;description from the publisher&amp;#10;&amp;#10;</description>
<yearpublished value="2017"/>
<minplayers value="3"/>
<maxplayers value="6"/>
<poll name="suggested_numplayers" title="User Suggested Number of Players" totalvotes="486">
<results numplayers="1">		
<result value="Best" numvotes="0"/>
<result value="Recommended" numvotes="4"/>
<result value="Not Recommended" numvotes="344"/>
</results>					
<results numplayers="2">		
<result value="Best" numvotes="0"/>
<result value="Recommended" numvotes="14"/>
<result value="Not Recommended" numvotes="337"/>
</results>					
<results numplayers="3">		
<result value="Best" numvotes="13"/>
<result value="Recommended" numvotes="199"/>
<result value="Not Recommended" numvotes="169"/>
</results>					
<results numplayers="4">		
<result value="Best" numvotes="123"/>
<result value="Recommended" numvotes="232"/>
<result value="Not Recommended" numvotes="62"/>
</results>					
<results numplayers="5">		
<result value="Best" numvotes="82"/>
<result value="Recommended" numvotes="288"/>
<result value="Not Recommended" numvotes="41"/>
</results>					
<results numplayers="6">		
<result value="Best" numvotes="351"/>
<result value="Recommended" numvotes="67"/>
<result value="Not Recommended" numvotes="21"/>
</results>					
<results numplayers="6+">		
<result value="Best" numvotes="9"/>
<result value="Recommended" numvotes="51"/>
<result value="Not Recommended" numvotes="198"/>
</results>					
</poll>
<playingtime value="480"/>
<minplaytime value="240"/>
<maxplaytime value="480"/>
<minage value="14"/>
<poll name="suggested_playerage" title="User Suggested Player Age" totalvotes="87">
<results>		
<result value="2" numvotes="0"/>
<result value="3" numvotes="0"/>
<result value="4" numvotes="0"/>
<result value="5" numvotes="0"/>
<result value="6" numvotes="0"/>
<result value="8" numvotes="0"/>
<result value="10" numvotes="6"/>
<result value="12" numvotes="14"/>
<result value="14" numvotes="37"/>
<result value="16" numvotes="25"/>
<result value="18" numvotes="3"/>
<result value="21 and up" numvotes="2"/>
</results>					
</poll>
<poll name="language_dependence" title="Language Dependence" totalvotes="24">
<results>		
<result level="421" value="No necessary in-game text" numvotes="0"/>
<result level="422" value="Some necessary text - easily memorized or small crib sheet" numvotes="0"/>
<result level="423" value="Moderate in-game text - needs crib sheet or paste ups" numvotes="2"/>
<result level="424" value="Extensive use of text - massive conversion needed to be playable" numvotes="17"/>
<result level="425" value="Unplayable in another language" numvotes="5"/>
</results>					
</poll> 			      			 			      				
<link type="boardgamecategory" id="1015" value="Civilization"/>
<link type="boardgamecategory" id="1021" value="Economic"/>
<link type="boardgamecategory" id="1020" value="Exploration"/>
<link type="boardgamecategory" id="1026" value="Negotiation"/>
<link type="boardgamecategory" id="1001" value="Political"/>
<link type="boardgamecategory" id="1016" value="Science Fiction"/>
<link type="boardgamecategory" id="1113" value="Space Exploration"/>
<link type="boardgamecategory" id="1019" value="Wargame"/>
<link type="boardgamemechanic" id="2838" value="Action Drafting"/>
<link type="boardgamemechanic" id="2080" value="Area Majority / Influence"/>
<link type="boardgamemechanic" id="2021" value="Area-Impulse"/>
<link type="boardgamemechanic" id="2072" value="Dice Rolling"/>
<link type="boardgamemechanic" id="2843" value="Follow"/>
<link type="boardgamemechanic" id="2676" value="Grid Movement"/>
<link type="boardgamemechanic" id="2026" value="Hexagon Grid"/>
<link type="boardgamemechanic" id="2914" value="Increase Value of Unchosen Resources"/>
<link type="boardgamemechanic" id="2886" value="King of the Hill"/>
<link type="boardgamemechanic" id="2011" value="Modular Board"/>
<link type="boardgamemechanic" id="2876" value="Race"/>
<link type="boardgamemechanic" id="2849" value="Tech Trees / Tech Tracks"/>
<link type="boardgamemechanic" id="2008" value="Trading"/>
<link type="boardgamemechanic" id="2079" value="Variable Phase Order"/>
<link type="boardgamemechanic" id="2015" value="Variable Player Powers"/>
<link type="boardgamemechanic" id="2897" value="Variable Set-up"/>
<link type="boardgamemechanic" id="2017" value="Voting"/>
<link type="boardgamefamily" id="67874" value="Components: Hexagonal Tiles"/>
<link type="boardgamefamily" id="64949" value="Components: Map (Interplanetary or Interstellar scale)"/>
<link type="boardgamefamily" id="25158" value="Components: Miniatures"/>
<link type="boardgamefamily" id="29" value="Game: Twilight Imperium"/>
<link type="boardgamefamily" id="12210" value="Mechanism: 4X"/>
<link type="boardgamefamily" id="78680" value="Misc: Made by Panda"/>
<link type="boardgameexpansion" id="315895" value="Twilight Imperium: Fourth Edition – Prophecy of Kings"/>
<link type="boardgameexpansion" id="332157" value="Twilight Imperium: Fourth Edition – Twilight Codex Volume I: Ordinian"/>
<link type="boardgameexpansion" id="336970" value="Twilight Imperium: Fourth Edition – Twilight Codex Volume II: Affinity"/>
<link type="boardgameexpansion" id="362201" value="Twilight Imperium: Fourth Edition – Twilight Codex Volume III: Vigil"/>
<link type="boardgameaccessory" id="332494" value="Twilight Imperium: Fourth Edition – reDrewno Insert"/>
<link type="boardgameaccessory" id="306385" value="Twilight Imperium (Fourth Edition): Broken Token Board Frames"/>
<link type="boardgameaccessory" id="262962" value="Twilight Imperium (Fourth Edition): Deluxe Rulebook"/>
<link type="boardgameaccessory" id="309437" value="Twilight Imperium (Fourth Edition): e-Raptor Insert"/>
<link type="boardgameaccessory" id="267464" value="Twilight Imperium (Fourth Edition): Folded Space Insert"/>
<link type="boardgameaccessory" id="243197" value="Twilight Imperium (Fourth Edition): Galactic Gamemat"/>
<link type="boardgameaccessory" id="297573" value="Twilight Imperium (Fourth Edition): Gamefit Fixators of the Field"/>
<link type="boardgameaccessory" id="297572" value="Twilight Imperium (Fourth Edition): Gamefit Insert"/>
<link type="boardgameaccessory" id="306357" value="Twilight Imperium (Fourth Edition): Laserox Command &amp; Control Tokens"/>
<link type="boardgameaccessory" id="306358" value="Twilight Imperium (Fourth Edition): Laserox Commodity &amp; Trade Tokens"/>
<link type="boardgameaccessory" id="306359" value="Twilight Imperium (Fourth Edition): Laserox Infantry &amp; Fighter Tokens"/>
<link type="boardgameaccessory" id="365794" value="Twilight Imperium (Fourth Edition): Tower Rex Organizer"/>
<link type="boardgameaccessory" id="376437" value="Twilight Imperium: CMON Comics – Vol. 2 Promos"/>
<link type="boardgameaccessory" id="347404" value="Twilight Imperium: Fourth Edition – Game Tamer Organizer"/>
<link type="boardgameaccessory" id="326743" value="Twilight Imperium: Laserox Twilight Treasury insert"/>
<link type="boardgameaccessory" id="376502" value="Twilight Imperium: Prime Game Mat"/>
<link type="boardgameimplementation" id="12493" value="Twilight Imperium: Third Edition" inbound="true"/>
<link type="boardgamedesigner" id="96049" value="Dane Beltrami"/>
<link type="boardgamedesigner" id="6651" value="Corey Konieczka"/>
<link type="boardgamedesigner" id="21" value="Christian T. Petersen"/>
<link type="boardgameartist" id="11988" value="Scott Schomburg"/>
<link type="boardgamepublisher" id="17" value="Fantasy Flight Games"/>
<link type="boardgamepublisher" id="23043" value="ADC Blackfire Entertainment"/>
<link type="boardgamepublisher" id="3475" value="Arclight Games"/>
<link type="boardgamepublisher" id="157" value="Asmodee"/>
<link type="boardgamepublisher" id="15889" value="Asterion Press"/>
<link type="boardgamepublisher" id="2973" value="Edge Entertainment"/>
<link type="boardgamepublisher" id="4617" value="Galakta"/>
<link type="boardgamepublisher" id="15605" value="Galápagos Jogos"/>
<link type="boardgamepublisher" id="18852" value="Hobby World"/>
<link type="boardgamepublisher" id="34744" value="Playfun Games"/>
<link type="boardgamepublisher" id="39249" value="sternenschimmermeer"/>
</item>
</items>`;

const getProps = (xml: string) => {
  const res: any = {};

  const props = xml.match(/\w+="(?:[^"]|(?<=\\)")*"/g) || [];
  for (let p of props) {
    let [key, value] = p.split('="');
    value = value.slice(0, -1);
    res[key] = value;
  }

  return res;
};

export const parse = (xml: string) => {
  xml = xml.replace(/<\?xml[^>]+>/g, "");
  const formattedXml = xml
    .split(/(?<=>)|(?=<\/)/)
    .map((v) => v.trim())
    .filter((v) => v);

  const toJSON = (lines: Array<string>) => {
    if (!lines[0].startsWith("<")) {
      return { _v: lines[0] };
    } else {
      const res: any = {};

      while (lines.length > 0) {
        const tag = lines[0].match(/[^<>\s]+/)![0];

        if (res[tag] === undefined) {
          res[tag] = {};
        } else if (!Array.isArray(res[tag]._v)) {
          res[tag]._v = [res[tag]._v];
        }

        const props = getProps(lines[0]);
        if (Object.keys(props).length > 0) {
          res[tag].$ = props;
        }
        
        const closingTagIdx = lines[0].endsWith("/>")
          ? 0
          : lines.findIndex((l) => RegExp(`^</\\s*${tag}`).test(l));

        if (closingTagIdx > 0) {
          const children = toJSON(lines.slice(1, closingTagIdx));
          if (Array.isArray(res[tag])) {
            res[tag]._v.push(children);
          } else {
            res[tag]._v = children;
          }
        }

        lines = lines.slice(closingTagIdx + 1);
      }

      return res;
    }
  };

  return toJSON(formattedXml);
};

console.log(JSON.stringify(parse(xml), null, 2));
